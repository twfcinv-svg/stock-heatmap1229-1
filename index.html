<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‚¡ç¥¨ç†±åŠ›åœ–ï¼ˆå¯ä¸Šå‚³ / å¯åˆ†äº«ï¼‰</title>

  <!-- Plotly Treemap -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Excel parser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- URL-friendly compression -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif; }
    header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
    h1 { margin: 0; font-size: 18px; }
    .muted { color: var(--muted); font-size: 13px; margin-top: 6px; line-height: 1.5; }
    .bar { display:flex; gap:10px; flex-wrap: wrap; padding: 12px 16px; border-bottom: 1px solid var(--border); align-items: center; }
    button { padding: 8px 10px; border: 1px solid var(--border); background: #fff; border-radius: 10px; cursor:pointer; }
    button:hover { background:#f9fafb; }
    input[type="file"] { padding: 6px 0; }
    input[type="text"] { padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; min-width: 280px; }
    #msg { padding: 0 16px 10px; color: #b91c1c; font-size: 13px; min-height: 18px; }
    #chart { height: calc(100vh - 140px); }
    .ok { color: #047857 !important; }
    .drop {
      margin: 10px 16px 0;
      border: 2px dashed var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>

<body>
  <header>
    <h1>è‚¡ç¥¨ç†±åŠ›åœ–ï¼ˆä¸Šå‚³è³‡æ–™ â†’ ç”¢ç”Ÿåˆ†äº«é€£çµï¼‰</h1>
    <div class="muted">
      é è¨­æœƒå˜—è©¦è®€å–åŒè³‡æ–™å¤¾çš„ <b>data.csv</b>ã€‚ä½ ä¹Ÿå¯ä»¥æ‹–æ‹‰/é¸æª”ä¸Šå‚³ CSV/XLSX/JSONã€‚
      ã€Œç”¢ç”Ÿåˆ†äº«é€£çµã€æœƒæŠŠè³‡æ–™å£“ç¸®å¾Œæ”¾é€²ç¶²å€ #hashï¼Œåˆ†äº«çµ¦åˆ¥äººå³å¯çœ‹åˆ°åŒä¸€å¼µåœ–ã€‚
    </div>
  </header>

  <div class="bar">
    <input id="file" type="file" accept=".csv,.xlsx,.xls,.json" />
    <button id="btnLoadDefault">è¼‰å…¥ï¼ˆæˆ–é‡è¼‰ï¼‰data.csv</button>
    <button id="btnShare">ç”¢ç”Ÿåˆ†äº«é€£çµ</button>
    <button id="btnCopy" disabled>è¤‡è£½åˆ†äº«é€£çµ</button>
    <span class="muted">æˆ–å¾ç¶²å€è¼‰å…¥ CSVï¼š</span>
    <input id="csvUrl" type="text" placeholder="è²¼ä¸Š data.csv çš„å…¬é–‹ç¶²å€ï¼ˆrawï¼‰" />
    <button id="btnLoadUrl">å¾ç¶²å€è¼‰å…¥</button>
  </div>

  <div class="drop">ğŸ“¥ ä½ ä¹Ÿå¯ä»¥æŠŠæª”æ¡ˆç›´æ¥æ‹–æ›³åˆ°é€™å€‹é é¢ä»»ä½•ä½ç½®æ”¾é–‹ï¼ˆCSV / XLSX / JSONï¼‰ã€‚</div>
  <div id="msg"></div>
  <div id="chart"></div>

<script>
  const $msg = document.getElementById('msg');
  const $file = document.getElementById('file');
  const $btnLoadDefault = document.getElementById('btnLoadDefault');
  const $btnShare = document.getElementById('btnShare');
  const $btnCopy = document.getElementById('btnCopy');
  const $csvUrl = document.getElementById('csvUrl');
  const $btnLoadUrl = document.getElementById('btnLoadUrl');

  let lastRows = null;

  function setMsg(text, ok=false) {
    $msg.textContent = text || '';
    $msg.className = ok ? 'ok' : '';
  }

  function toNumber(x) {
    if (x === null || x === undefined) return NaN;
    if (typeof x === 'number') return x;
    const s = String(x).trim().replace('%','');
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function pickColumn(headers, candidates) {
    const lower = headers.map(h => String(h).trim().toLowerCase());
    for (const c of candidates) {
      const idx = lower.indexOf(String(c).toLowerCase());
      if (idx >= 0) return headers[idx];
    }
    return null;
  }

  function normalizeRows(rawRows) {
    if (!Array.isArray(rawRows) || rawRows.length === 0) throw new Error('æ²’æœ‰è®€åˆ°ä»»ä½•è³‡æ–™åˆ—ã€‚');

    const headers = Object.keys(rawRows[0] || {});
    if (headers.length === 0) throw new Error('æ‰¾ä¸åˆ°æ¬„ä½ï¼ˆheaderï¼‰ã€‚');

    const colGroup  = pickColumn(headers, ['group','sector','industry','åˆ†é¡','ç”¢æ¥­','é¡åˆ¥']);
    const colSymbol = pickColumn(headers, ['symbol','ticker','code','ä»£ç¢¼','è‚¡ç¥¨','stock','name']);
    const colValue  = pickColumn(headers, ['value','size','market_cap','marketcap','weight','å¸‚å€¼','æ¬Šé‡','æˆäº¤é‡‘é¡','amount']);
    const colChange = pickColumn(headers, ['change','chg','return','pct','perf','æ¼²è·Œ','æ¼²è·Œå¹…','å ±é…¬','å ±é…¬ç‡']);

    if (!colSymbol) throw new Error('æ‰¾ä¸åˆ°ã€Œsymbolã€æ¬„ä½ï¼ˆå¯æ¥å—ï¼šsymbol/ticker/code/ä»£ç¢¼/è‚¡ç¥¨ï¼‰ã€‚');
    if (!colChange) throw new Error('æ‰¾ä¸åˆ°ã€Œchangeã€æ¬„ä½ï¼ˆå¯æ¥å—ï¼šchange/return/pct/æ¼²è·Œå¹…ï¼‰ã€‚');

    const rows = rawRows.map((r) => {
      const group = colGroup ? String(r[colGroup] ?? 'æœªåˆ†é¡').trim() : 'æœªåˆ†é¡';
      const symbol = String(r[colSymbol] ?? '').trim();
      const value = colValue ? toNumber(r[colValue]) : 1;
      const change = toNumber(r[colChange]);

      if (!symbol) return null;
      return {
        group,
        symbol,
        value: Number.isFinite(value) && value > 0 ? value : 1,
        change: Number.isFinite(change) ? change : 0
      };
    }).filter(Boolean);

    if (rows.length === 0) throw new Error('è³‡æ–™åˆ—è§£æå¾Œç‚ºç©ºï¼ˆå¯èƒ½ symbol æ¬„ä½éƒ½æ˜¯ç©ºçš„ï¼‰ã€‚');
    return rows;
  }

  function buildTreemap(rows) {
    const groupMap = new Map();
    for (const r of rows) {
      if (!groupMap.has(r.group)) groupMap.set(r.group, {value:0, wchg:0});
      const g = groupMap.get(r.group);
      g.value += r.value;
      g.wchg += r.change * r.value;
    }

    const labels = ['å…¨éƒ¨'];
    const parents = [''];
    const values = [0];
    const colors = [0];

    for (const [gname, g] of groupMap.entries()) {
      labels.push(gname);
      parents.push('å…¨éƒ¨');
      values.push(g.value);
      colors.push(g.value ? (g.wchg / g.value) : 0);
    }

    for (const r of rows) {
      labels.push(r.symbol);
      parents.push(r.group);
      values.push(r.value);
      colors.push(r.change);
    }

    values[0] = Array.from(groupMap.values()).reduce((s,x)=>s+x.value,0);
    return {labels, parents, values, colors};
  }

  function render(rows) {
    const {labels, parents, values, colors} = buildTreemap(rows);
    lastRows = rows;

    const data = [{
      type: 'treemap',
      labels,
      parents,
      values,
      branchvalues: 'total',
      marker: {
        colors,
        colorscale: 'RdYlGn',
        cmid: 0,
        line: { width: 1, color: '#ffffff' }
      },
      hovertemplate:
        '<b>%{label}</b><br>' +
        'åˆ†é¡ï¼š%{parent}<br>' +
        'å¤§å°ï¼š%{value}<br>' +
        'è®Šå‹•ï¼š%{color:.2f}<extra></extra>'
    }];

    Plotly.newPlot('chart', data, {margin:{l:10,r:10,t:10,b:10}}, {responsive:true, displaylogo:false});
    setMsg('å·²æ›´æ–°ç†±åŠ›åœ–ã€‚', true);
    $btnCopy.disabled = true;
  }

  function loadCSVText(text) {
    const parsed = Papa.parse(text, {header: true, skipEmptyLines: true});
    if (parsed.errors && parsed.errors.length) {
      throw new Error('CSV è§£æéŒ¯èª¤ï¼š' + parsed.errors[0].message);
    }
    return parsed.data;
  }

  async function handleFile(file) {
    setMsg('');
    const name = (file.name || '').toLowerCase();
    const buf = await file.arrayBuffer();

    if (name.endsWith('.csv')) {
      const text = new TextDecoder('utf-8').decode(buf);
      render(normalizeRows(loadCSVText(text)));
      return;
    }
    if (name.endsWith('.json')) {
      const text = new TextDecoder('utf-8').decode(buf);
      const raw = JSON.parse(text);
      const rawRows = Array.isArray(raw) ? raw : (raw.rows || raw.data || []);
      render(normalizeRows(rawRows));
      return;
    }
    if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
      const wb = XLSX.read(buf, {type: 'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rawRows = XLSX.utils.sheet_to_json(sheet, {defval: ''});
      render(normalizeRows(rawRows));
      return;
    }
    throw new Error('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ç”¨ CSV / XLSX / JSONã€‚');
  }

  function makeShareLink(rows) {
    const payload = {v: 1, rows};
    const json = JSON.stringify(payload);
    const compressed = LZString.compressToEncodedURIComponent(json);
    return `${location.origin}${location.pathname}#data=${compressed}`;
  }

  function tryLoadFromHash() {
    const hash = location.hash || '';
    if (!hash.startsWith('#data=')) return false;
    try {
      const encoded = hash.slice(6);
      const json = LZString.decompressFromEncodedURIComponent(encoded);
      const payload = JSON.parse(json);
      if (!payload || !Array.isArray(payload.rows)) throw new Error('hash å…§å®¹ä¸æ­£ç¢º');
      render(payload.rows);
      setMsg('å·²å¾åˆ†äº«é€£çµè¼‰å…¥è³‡æ–™ã€‚', true);
      return true;
    } catch (e) {
      setMsg('åˆ†äº«é€£çµè§£æå¤±æ•—ï¼š' + (e?.message || e));
      return false;
    }
  }

  async function loadFromUrl(url) {
    setMsg('');
    if (!url) throw new Error('è«‹è²¼ä¸Š CSV çš„å…¬é–‹ç¶²å€ã€‚');
    const res = await fetch(url, {cache: 'no-store'});
    if (!res.ok) throw new Error(`æŠ“å–å¤±æ•—ï¼šHTTP ${res.status}`);
    const text = await res.text();
    render(normalizeRows(loadCSVText(text)));
  }

  async function loadDefaultCSV() {
    try {
      // åœ¨ GitHub Pages æœƒæˆåŠŸï¼›åœ¨æœ¬æ©Ÿ file:// å¯èƒ½è¢«ç€è¦½å™¨é™åˆ¶è€Œå¤±æ•—ï¼ˆæ­£å¸¸ï¼‰
      const res = await fetch('./data.csv', {cache: 'no-store'});
      if (!res.ok) throw new Error(`æŠ“å– data.csv å¤±æ•—ï¼šHTTP ${res.status}`);
      const text = await res.text();
      render(normalizeRows(loadCSVText(text)));
      setMsg('å·²è¼‰å…¥ data.csvã€‚', true);
    } catch (e) {
      setMsg('è¼‰å…¥ data.csv å¤±æ•—ï¼ˆæœ¬æ©Ÿ file:// å¸¸è¦‹é™åˆ¶ï¼Œéƒ¨ç½²åˆ° Pages å°±æ­£å¸¸ï¼‰ï¼š' + (e?.message || e));
    }
  }

  // events
  $file.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try { await handleFile(f); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  // drag & drop
  window.addEventListener('dragover', (e) => { e.preventDefault(); });
  window.addEventListener('drop', async (e) => {
    e.preventDefault();
    const f = e.dataTransfer?.files?.[0];
    if (!f) return;
    try { await handleFile(f); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  $btnLoadDefault.addEventListener('click', loadDefaultCSV);

  document.getElementById('btnShare').addEventListener('click', () => {
    try {
      if (!lastRows) throw new Error('è«‹å…ˆä¸Šå‚³è³‡æ–™æˆ–æˆåŠŸè¼‰å…¥ data.csvã€‚');
      const url = makeShareLink(lastRows);
      location.hash = url.split('#')[1];
      setMsg('å·²ç”¢ç”Ÿåˆ†äº«é€£çµï¼ˆè³‡æ–™å·²å¯«å…¥ç¶²å€ #hashï¼‰ã€‚å¯æŒ‰ã€Œè¤‡è£½åˆ†äº«é€£çµã€ã€‚', true);
      $btnCopy.disabled = false;
    } catch (err) {
      setMsg(err?.message || String(err));
    }
  });

  $btnCopy.addEventListener('click', async () => {
    try {
      const url = `${location.origin}${location.pathname}${location.hash}`;
      await navigator.clipboard.writeText(url);
      setMsg('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚', true);
    } catch (err) {
      setMsg('è¤‡è£½å¤±æ•—ï¼šä½ å¯ä»¥ç›´æ¥æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—ã€‚');
    }
  });

  $btnLoadUrl.addEventListener('click', async () => {
    try { await loadFromUrl($csvUrl.value.trim()); }
    catch (err) { setMsg(err?.message || String(err)); }
  });

  // boot
  if (!tryLoadFromHash()) {
    loadDefaultCSV();
  }
</script>
</body>
</html>
